import { describe, expect, test } from "@jest/globals";
import { ethers } from "ethers";
import SDK from "../src";
import RheoABI from "../src/v1.9/abi/Rheo.json";
import SizeFactoryABI from "../src/v1.9/abi/SizeFactory.json";
import ErrorsABI from "../src/v1.9/abi/Errors.json";

describe("@rheo/sdk v1.9", () => {
  const sizeFactory = "0x000000000000000000000000000000000000ffff";
  const market = "0x0000000000000000000000000000000000000123";
  const alice = "0x0000000000000000000000000000000000010000";
  const bob = "0x0000000000000000000000000000000000020000";
  const charlie = "0x0000000000000000000000000000000000030000";
  const market2 = "0x0000000000000000000000000000000000000456";
  const weth = "0x4200000000000000000000000000000000000006";
  const collateral2 = "0x0000000000000000000000000000000000007777";
  const usdc = "0x0000000000000000000000000000000000008888";

  const IRheo = new ethers.utils.Interface(RheoABI.abi);
  const ISizeFactory = new ethers.utils.Interface(SizeFactoryABI.abi);
  const IErrors = new ethers.utils.Interface(ErrorsABI.abi);

  test("builds fixed-maturity buyCreditLimit", () => {
    const sdk = new SDK({
      sizeFactory,
      version: "v1.9",
    });

    const maturities = [1893456000n, 1893542400n];
    const aprs = [500n, 600n];

    const txs = sdk.tx.build(alice, [
      sdk.market.buyCreditLimit(market, {
        maturities,
        aprs,
      }),
    ]);

    expect(txs[0].target).toBe(market);
    expect(txs[0].data).toBe(
      IRheo.encodeFunctionData("buyCreditLimit", [{ maturities, aprs }]),
    );
  });

  test("builds buyCreditMarket with maturity", () => {
    const sdk = new SDK({
      sizeFactory,
      version: "v1.9",
    });

    const params = {
      borrower: alice,
      creditPositionId: ethers.constants.MaxUint256,
      amount: 100n,
      maturity: 1893456000n,
      deadline: 1893457000n,
      minAPR: 0n,
      exactAmountIn: true,
      collectionId: 0,
      rateProvider: ethers.constants.AddressZero,
    };

    const txs = sdk.tx.build(alice, [sdk.market.buyCreditMarket(market, params)]);

    expect(txs[0].target).toBe(market);
    expect(txs[0].data).toBe(
      IRheo.encodeFunctionData("buyCreditMarket", [params]),
    );
  });

  test("v1.9 ideal flow encoding + decoding", () => {
    const sdk = new SDK({
      sizeFactory,
      version: "v1.9",
    });

    const maturities = [1893456000n, 1893542400n];
    const aprs = [500n, 600n];

    const txs = sdk.tx.build(alice, [
      sdk.market.setVault(market2, {
        vault: "0x000000000000000000000000000000000000eeee",
        forfeitOldShares: false,
      }),
      sdk.market.deposit(market, {
        amount: 100n,
        to: "0x0000000000000000000000000000000000001337",
        token: weth,
      }),
      sdk.market.buyCreditLimit(market, {
        maturities,
        aprs,
      }),
      sdk.market.setCopyLimitOrderConfigs(market, {
        copyLoanOfferConfig: sdk.constants.FullCopy,
        copyBorrowOfferConfig: sdk.constants.NoCopy,
      }),
      sdk.factory.subscribeToCollections([42n]),
    ]);

    const decoded = sdk.decode.calldata(txs[0].data);

    const expectedCalldata =
      "0xac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000840000000000000000000000000000000000000000000000000000000000000004491c769ce000000000000000000000000000000000000000000000000000000000000ffff00000000000000000000000000000000000000000000000000000000000006050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e45ec4954400000000000000000000000000000000000000000000000000000000000004560000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000006475829a36000000000000000000000000000000000000000000000000000000000000eeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005245ec495440000000000000000000000000000000000000000000000000000000000000123000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000004a4ac9650d8000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000084fa823af500000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000133700000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001648ccad699000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000070dbd8800000000000000000000000000000000000000000000000000000000070dd2a00000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000001f400000000000000000000000000000000000000000000000000000000000002580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001647a32376a0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000064c8fb624700000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004491c769ce000000000000000000000000000000000000000000000000000000000000ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

    expect(txs[0].data).toBe(expectedCalldata);
    expect(decoded).toBe(`multicall(
  [
    setAuthorization(
      0x000000000000000000000000000000000000FFff,
      [DEPOSIT,BUY_CREDIT_LIMIT,SET_COPY_LIMIT_ORDER_CONFIGS,SET_VAULT]
    ),
    callMarket(
      0x0000000000000000000000000000000000000456,
      setVaultOnBehalfOf(
        {
          params: {
            vault: 0x000000000000000000000000000000000000EEEe,
            forfeitOldShares: false
          },
          onBehalfOf: 0x0000000000000000000000000000000000010000
        }
      )
    ),
    callMarket(
      0x0000000000000000000000000000000000000123,
      multicall(
        [
          depositOnBehalfOf(
            {
              params: {
                token: 0x4200000000000000000000000000000000000006,
                amount: 100,
                to: 0x0000000000000000000000000000000000001337
              },
              onBehalfOf: 0x0000000000000000000000000000000000010000
            }
          ),
          buyCreditLimitOnBehalfOf(
            {
              params: {
                maturities: [1893456000,1893542400],
                aprs: [500,600]
              },
              onBehalfOf: 0x0000000000000000000000000000000000010000
            }
          ),
          setCopyLimitOrderConfigsOnBehalfOf(
            {
              params: {
                copyLoanOfferConfig: {
                  minTenor: 0,
                  maxTenor: type(uint256).max,
                  minAPR: 0,
                  maxAPR: type(uint256).max,
                  offsetAPR: 0
                },
                copyBorrowOfferConfig: {
                  minTenor: 0,
                  maxTenor: 0,
                  minAPR: 0,
                  maxAPR: 0,
                  offsetAPR: type(int256).min
                }
              },
              onBehalfOf: 0x0000000000000000000000000000000000010000
            }
          )
        ]
      )
    ),
    subscribeToCollections(
      [42]
    ),
    setAuthorization(
      0x000000000000000000000000000000000000FFff,
      []
    )
  ]
)`);
  });

  test("v1.9 borrow from multiple markets encoding + decoding", () => {
    const sdk = new SDK({
      sizeFactory,
      version: "v1.9",
    });

    const wethAmount = 300n;
    const collateral2Amount = 400n;
    const usdcAmount = 100n;
    const maturity = 1893456000n;
    const deadline = 1893457000n;

    const txs = sdk.tx.build(alice, [
      sdk.market.deposit(market, {
        amount: wethAmount,
        to: alice,
        token: weth,
      }),
      sdk.market.sellCreditMarket(market, {
        lender: bob,
        creditPositionId: ethers.constants.MaxUint256,
        amount: usdcAmount,
        maturity,
        deadline,
        maxAPR: ethers.constants.MaxUint256,
        exactAmountIn: false,
        collectionId: 0,
        rateProvider: ethers.constants.AddressZero,
      }),
      sdk.market.deposit(market2, {
        amount: collateral2Amount,
        to: alice,
        token: collateral2,
      }),
      sdk.market.sellCreditMarket(market2, {
        lender: charlie,
        creditPositionId: ethers.constants.MaxUint256,
        amount: usdcAmount,
        maturity,
        deadline,
        maxAPR: ethers.constants.MaxUint256,
        exactAmountIn: false,
        collectionId: 0,
        rateProvider: ethers.constants.AddressZero,
      }),
      sdk.market.withdraw(market, {
        token: usdc,
        amount: ethers.constants.MaxUint256,
        to: alice,
      }),
    ]);

    const decoded = sdk.decode.calldata(txs[0].data);

    const expectedCalldata =
      "0xac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000004c0000000000000000000000000000000000000000000000000000000000000086000000000000000000000000000000000000000000000000000000000000009a0000000000000000000000000000000000000000000000000000000000000004491c769ce000000000000000000000000000000000000000000000000000000000000ffff00000000000000000000000000000000000000000000000000000000000000230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003645ec495440000000000000000000000000000000000000000000000000000000000000123000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002e4ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000084fa823af50000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000012c000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001643962a6860000000000000000000000000000000000000000000000000000000000020000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000070dbd8800000000000000000000000000000000000000000000000000000000070dbdc68ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003645ec495440000000000000000000000000000000000000000000000000000000000000456000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002e4ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000084fa823af500000000000000000000000000000000000000000000000000000000000077770000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001643962a6860000000000000000000000000000000000000000000000000000000000030000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000070dbd8800000000000000000000000000000000000000000000000000000000070dbdc68ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001045ec49544000000000000000000000000000000000000000000000000000000000000012300000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000084f54ae18b0000000000000000000000000000000000000000000000000000000000008888ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004491c769ce000000000000000000000000000000000000000000000000000000000000ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

    expect(txs[0].data).toBe(expectedCalldata);
    expect(decoded).toBe(`multicall(
  [
    setAuthorization(
      0x000000000000000000000000000000000000FFff,
      [DEPOSIT,WITHDRAW,SELL_CREDIT_MARKET]
    ),
    callMarket(
      0x0000000000000000000000000000000000000123,
      multicall(
        [
          depositOnBehalfOf(
            {
              params: {
                token: 0x4200000000000000000000000000000000000006,
                amount: 300,
                to: 0x0000000000000000000000000000000000010000
              },
              onBehalfOf: 0x0000000000000000000000000000000000010000
            }
          ),
          sellCreditMarketOnBehalfOf(
            {
              params: {
                lender: 0x0000000000000000000000000000000000020000,
                creditPositionId: type(uint256).max,
                amount: 100,
                tenor: 1893456000,
                deadline: 1893457000,
                maxAPR: type(uint256).max,
                exactAmountIn: false,
                collectionId: 0,
                rateProvider: address(0)
              },
              onBehalfOf: 0x0000000000000000000000000000000000010000,
              recipient: 0x0000000000000000000000000000000000010000
            }
          )
        ]
      )
    ),
    callMarket(
      0x0000000000000000000000000000000000000456,
      multicall(
        [
          depositOnBehalfOf(
            {
              params: {
                token: 0x0000000000000000000000000000000000007777,
                amount: 400,
                to: 0x0000000000000000000000000000000000010000
              },
              onBehalfOf: 0x0000000000000000000000000000000000010000
            }
          ),
          sellCreditMarketOnBehalfOf(
            {
              params: {
                lender: 0x0000000000000000000000000000000000030000,
                creditPositionId: type(uint256).max,
                amount: 100,
                tenor: 1893456000,
                deadline: 1893457000,
                maxAPR: type(uint256).max,
                exactAmountIn: false,
                collectionId: 0,
                rateProvider: address(0)
              },
              onBehalfOf: 0x0000000000000000000000000000000000010000,
              recipient: 0x0000000000000000000000000000000000010000
            }
          )
        ]
      )
    ),
    callMarket(
      0x0000000000000000000000000000000000000123,
      withdrawOnBehalfOf(
        {
          params: {
            token: 0x0000000000000000000000000000000000008888,
            amount: type(uint256).max,
            to: 0x0000000000000000000000000000000000010000
          },
          onBehalfOf: 0x0000000000000000000000000000000000010000
        }
      )
    ),
    setAuthorization(
      0x000000000000000000000000000000000000FFff,
      []
    )
  ]
)`);
  });

  test("builds subscribe/unsubscribe with BigNumberish[] inputs", () => {
    const sdk = new SDK({
      sizeFactory,
      version: "v1.9",
    });

    const subscribeParams = [ethers.BigNumber.from(42), "43"];
    const unsubscribeParams = [ethers.BigNumber.from(13), "14"];

    const txs = sdk.tx.build(alice, [
      sdk.factory.subscribeToCollections(subscribeParams),
      sdk.factory.unsubscribeFromCollections(unsubscribeParams),
    ]);

    const subscribeData = ISizeFactory.encodeFunctionData(
      "subscribeToCollections",
      [subscribeParams],
    );
    const unsubscribeData = ISizeFactory.encodeFunctionData(
      "unsubscribeFromCollections",
      [unsubscribeParams],
    );
    const expected = ISizeFactory.encodeFunctionData("multicall", [
      [subscribeData, unsubscribeData],
    ]);

    expect(txs[0].target).toBe(sizeFactory);
    expect(txs[0].data).toBe(expected);
  });

  test("removes liquidateWithReplacement from interface", () => {
    expect(() => IRheo.getFunction("liquidateWithReplacement")).toThrow();
  });

  test("decodes INVALID_MATURITY error", () => {
    const sdk = new SDK({
      sizeFactory,
      version: "v1.9",
    });

    const errorData = IErrors.encodeErrorResult("INVALID_MATURITY", [123n]);
    expect(sdk.decode.error(errorData)).toBe("INVALID_MATURITY(123)");
  });

  test("market actions omit liquidateWithReplacement", () => {
    const sdk = new SDK({
      sizeFactory,
      version: "v1.9",
    });

    expect("liquidateWithReplacement" in sdk.market).toBe(false);
  });
});
